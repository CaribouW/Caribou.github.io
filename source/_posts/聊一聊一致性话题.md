---
title: 聊一聊一致性的话题
date: 2020-04-09 21:02:05
tags:
cover_img: https://images.unsplash.com/photo-1559251434-4e172832c9de?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=700&q=80
feature_img: https://images.unsplash.com/photo-1571606809798-027ae70d593f?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=634&q=80
description:
keywords:
---

## 主从复制

在分布式的 *CAP* 理论中，一致和可用我们往往都只能够偏向于其中的一者。这一点这里只是简单提一下。例如我们的 `zk`满足的就是 *CP*

<img src="https://img2018.cnblogs.com/blog/285763/201906/285763-20190621144256061-464757033.png" alt="img"  />

今天主要谈一谈数据库当中的一个 **一致性** 话题

### Mysql 主从复制

> 在分布式的数据库系统中，如果主数据库发生了故障，那么需要能够及时切换到从数据库，并且进行数据的恢复工作。如何保证主从数据库之间的数据一致性也就成为了焦点问题。这次把目光聚焦在 `Mysql` 上，探究它的主从复制原理
>
> 对于这些数据库而言，严格的一致性是一个目标

![image.png](https://i.loli.net/2020/04/09/e7iz9aotfqmlGHM.png)

- 主节点 `Master` 进行数据更新之后，会将更新日志写入 `binlog` 当中。此时创建的是第一个线程 `binlong dump thread`
- 随后从节点 `Slave`发起连接，连接到 `Master` ，从节点启东之后，启动线程 `IO thread` ，用于将 `binlog ` 内容写入到从节点的 `relay log` 
- 从节点随后创建 `SQL thread` ，用于从 `relay log` 中读取内容，并且开始进行写入操作

### Redis 主从复制

> 其主要的目的和 `Mysql` 一致，都是为了避免主节点失效之后的数据备份

#### 完整复制过程

- 启动 `Slave` ，建立和主节点 `Master` 的连接，发送 `sync` 命令
- `Master` 启动一个后台进程，将当前的快照存储到 `RDB`当中
  - 写入 `RDB` 的同时，可能会有数据的不一致性。这时候 `Master` 主进程会把写命令缓存
- `Master` 发送 `RDB` 给 `Slave` ，随后 `Slave` 进行磁盘保存
- `Slave` 加载 `RDB` 文件到内存恢复；
- `Master` 发送缓存给 `Slave`

> 存在的问题：
>
> 如果 `Slave` 停止运行，再次运行的时候可能部分的数据不同步；这时候的全数据恢复会非常耗时

#### 部分复制过程 

- `Slave` 连接 `Master` 之后，会主动发起 `PSYNC` 命令，`Slave` 提供 `runid` , `offset` 。如果 `Master` 认定无效，那么进行完整复制；否则根据  `offset` 进行部分数据的同步