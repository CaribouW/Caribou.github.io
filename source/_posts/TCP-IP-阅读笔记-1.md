---
title: TCP/IP 阅读笔记(1)
date: 2019-12-14 22:24:04
tags: 读书笔记
description: TCP协议基本内容
---

### TCP连接形式

TCP连接使用了一对套接字 (`socket`) 来进行唯一表示，也就是把 `IP` 头部的源和目的IP地址，携同TCP头部的源端口号和目的端口号，来进行一个标识。

### Seq 与 Ack

序列号与响应号是通信双方进行确认判定的依据。每一次报文中的响应号就是上一次报文的序列号  + 1 ，表示了接收方想要接收的下一个序列号。

我们所熟知的三次握手，其实本质上就是发送方和接收方的序列号交换：

> 第一次报文发送：SYN表明是客户端期望进行序列号同步，并且发送自己的序列号
>
> 第二次报文发送：SYN表示是服务端期望进行序列号同步，返回之前客户端的序列号 + 1 , 表示此时客户端序列号已经同步。此时还需要发送服务端自己的序列号，等待客户端是否给予最后一次响应。
>
> 第三次报文发送：ACK确实就是服务端序列号 + 1 的话，那么表明服务端的序列号也已经同步。至此通过三次报文交换来实现全双工通信的两端序列号同步。

对于四次挥手，其实也是序列号的交换问题。

书上的问题给出了进一步的思考：如果出现同时建立连接和同时断开连接，报文发送个数是多少？

- 对于同时建立连接的情况，一开始同时就会有两次报文发送，这时候两个报文都是 SYN，期望同步自己的序列号。此时连接两端的两个 `socket` 其实都只需要得到自己想要的 `ACK` 就可以了。这时候就是四次报文交换
- 对于同时断开连接的情况，和上面完全一样，也是四次

### TIME_WAIT问题

四次挥手结束之后，连接断开的发起者还会继续等待 `2MSL` 的时间长度，这种做法能够避免最后一次 **ACK** 因为网络问题没有发送到，给 **被动断开方** 时间进行超时重传。

在发起者还在等待的时候，其实两端的端口还是在连接的状态。问题就来了——端口占用问题。

也就是说，如果我们这时候在服务端或者客户端，断开 `socket` 却又立即重启，这时候就会出现端口占用的情况，导致我们的连接被拒绝。

